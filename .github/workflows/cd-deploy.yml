name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://int-travel-planner-staging.up.railway.app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -t int-travel-planner:staging \
            --target production \
            -f backend/Dockerfile \
            backend/
      
      - name: Run smoke tests against Docker image
        run: |
          docker run -d --name test-container \
            -p 8000:8000 \
            -e ENABLE_MOCK_DATA=true \
            -e REDIS_URL=redis://localhost:6379 \
            int-travel-planner:staging
          
          sleep 10
          
          curl -f http://localhost:8000/health/ready || exit 1
          
          docker stop test-container
          docker rm test-container
      
      - name: Deploy to Railway (Staging)
        run: |
          npm install -g @railway/cli
          railway link ${{ secrets.RAILWAY_STAGING_PROJECT_ID }}
          railway up --service backend --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Run post-deployment health checks
        run: |
          curl -f ${{ secrets.STAGING_URL }}/health/ready || exit 1
          curl -f ${{ secrets.STAGING_URL }}/health/live || exit 1
      
      - name: Run smoke tests on staging
        run: |
          curl -f -X POST ${{ secrets.STAGING_URL }}/api/v1/chat/message \
            -H "Content-Type: application/json" \
            -d '{"message": "test message"}' || exit 1
      
      - name: Notify deployment success
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'deployment/staging',
              description: 'Deployed to staging successfully'
            });

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://int-travel-planner.up.railway.app
    needs: []
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build Docker image
        run: |
          docker build -t int-travel-planner:production \
            --target production \
            -f backend/Dockerfile \
            backend/
      
      - name: Run smoke tests
        run: |
          docker run -d --name test-container \
            -p 8000:8000 \
            -e ENABLE_MOCK_DATA=true \
            int-travel-planner:production
          
          sleep 10
          curl -f http://localhost:8000/health/ready || exit 1
          docker stop test-container
          docker rm test-container
      
      - name: Deploy to Railway (Production)
        run: |
          npm install -g @railway/cli
          railway link ${{ secrets.RAILWAY_PRODUCTION_PROJECT_ID }}
          railway up --service backend --environment production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Run post-deployment health checks
        run: |
          curl -f ${{ secrets.PRODUCTION_URL }}/health/ready || exit 1
          curl -f ${{ secrets.PRODUCTION_URL }}/health/live || exit 1
      
      - name: Monitor error rates (10 minutes)
        run: |
          echo "Monitoring production for 10 minutes..."
          sleep 600
          
          # Check health endpoint remains healthy
          for i in {1..5}; do
            if ! curl -f ${{ secrets.PRODUCTION_URL }}/health/ready; then
              echo "Health check failed, triggering rollback"
              exit 1
            fi
            sleep 60
          done
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          railway rollback --service backend --environment production
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      
      - name: Tag release
        if: success()
        run: |
          git tag -a "v$(date +%Y%m%d-%H%M%S)" -m "Production deployment"
          git push origin --tags
      
      - name: Notify deployment success
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              context: 'deployment/production',
              description: 'Deployed to production successfully'
            });
